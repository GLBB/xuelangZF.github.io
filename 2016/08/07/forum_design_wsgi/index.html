<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>从零开始搭建论坛（二）：Web服务器网关接口 | Just For Fun</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.2.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="/css/donate.css"><link rel="stylesheet" type="text/css" href="/css/copyright.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.0.0/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">从零开始搭建论坛（二）：Web服务器网关接口</h1><a id="logo" href="/.">Just For Fun</a><p class="description">知其然，知其所以然。知识广度是深度的副产品！</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/aboutme.html"><i class="fa fa-user"> 关于</i></a><a href="/guestbook.html"><i class="fa fa-comments"> 留言</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">从零开始搭建论坛（二）：Web服务器网关接口</h1><div class="post-meta">Aug 7, 2016<span> | </span><span class="category"><a href="/categories/项目实践/">项目实践</a></span><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2016/08/07/forum_design_wsgi/" href="/2016/08/07/forum_design_wsgi/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><p>在 <a href="http://selfboot.cn/2016/07/28/forum_design_framework/">从零开始搭建论坛（一）：Web服务器与Web框架</a> 中我们弄清楚了Web 服务器、Web 应用程序、Web框架的概念。对于 Python 来说，越来越多的 Web 框架面世，在给我们更多选择机会的同时，也限制了我们对于 Web Server 的选择。同样是有着很多 Web 框架的Java，因为有着 servlet API 的存在，任何Java Web框架写的应用程序都可以运行在任意一个 Web Server 上。</p>
<p>Python 社区当然也需要这样一套 API，来适配Web服务器和应用程序，这套 API 就是 WSGI（Python Web Server Gateway Interface），在 <a href="https://www.python.org/dev/peps/pep-3333/" target="_blank" rel="external">PEP 3333</a> 里有详细的说明。简单来说，WSGI是连接Web服务器和Web应用程序的桥梁，一方面从Web server 拿到原始 HTTP 数据，处理成统一格式后交给 Web 应用程序，另一方面从应用程序／框架这边进行业务逻辑处理，生成响应内容后交给服务器。</p>
<p>Web服务器和框架通过 WSGI 来进行耦合的详细过程如下图所示：</p>
<p><img src="http://xuelangzf-github.qiniudn.com/20160807_forum_design_WSGI_1.png" alt="WSGI Server 适配"></p>
<a id="more"></a>
<p>具体解释如下：</p>
<ul>
<li>应用程序（网络框架）提供一个命名为application的可调用对象（WSGI协议并没有指定如何实现这个对象）。</li>
<li>服务器每次从HTTP客户端接收请求之后，调用可调用对象application，调用时传递一个名叫environ的字典作为参数，以及一个名为start_response的可调用对象。</li>
<li>框架/应用生成HTTP状态码以及HTTP响应报头，然后将二者传递至start_response，等待服务器保存。此外，框架/应用还将返回响应的正文。</li>
<li>服务器将状态码、响应报头和响应正文组合成HTTP响应，并返回给客户端（这一步并不属于WSGI协议）。</li>
</ul>
<p>下面分别从服务器端和应用程序端来看看 WSGI 是如何做适配的。</p>
<h1 id="服务器端"><a href="#服务器端" class="headerlink" title="服务器端"></a>服务器端</h1><p>我们知道客户端（通常是浏览器）发出的每个HTTP请求由请求行、消息报头、请求正文三部分组成，里面包含了本次请求的相关细节内容。比如：</p>
<ul>
<li>Method：指出在由Request-URI标识的资源上所执行的方法，包括GET，POST 等</li>
<li>User-Agent：允许客户端将它的操作系统、浏览器和其它属性告诉服务器；</li>
</ul>
<p>服务器从客户端接收HTTP请求之后，WSGI 接口必须要对这些请求字段进行统一化处理，方便传给应用服务器接口（其实就是给框架）。Web服务器具体传递哪些数据给应用程序，早在<a href="https://en.wikipedia.org/wiki/Common_Gateway_Interface" target="_blank" rel="external">CGI</a>（Common Gateway Interface，通用网关接口）里就有详细规定，这些数据被叫做 CGI 环境变量。WSGI 沿用了 CGI 环境变量的内容，要求 Web 服务器必须创建一个字典用来保存这些环境变量（一般将其命名为 <code>environ</code>）。除了 CGI 定义的变量，environ 还必须保存一些WSGI定义的变量，此外还可以保存一些客户端系统的环境变量，可以参考 <a href="https://www.python.org/dev/peps/pep-3333/#environ-variables" target="_blank" rel="external">environ Variables</a> 来看看具体有哪些变量。</p>
<p>接着 WSGI 接口必须将 environ 交给应用程序去处理，这里 WSGI 规定应用程序提供一个可调用对象 application，然后服务器去调用 application，获得返回值为HTTP响应正文。服务器在调用 application 的时候，需要提供两个变量，一个是前面提到的变量字典environ，另一个是可调用对象 start_response，它产生状态码和响应头，这样我们就得到了一个完整的HTTP响应。Web 服务器将响应返回给客户端，一次完整的<code>HTTP请求－响应</code>过程就完成了。</p>
<h2 id="wsgiref-分析"><a href="#wsgiref-分析" class="headerlink" title="wsgiref 分析"></a>wsgiref 分析</h2><p>Python 中内置了一个实现了WSGI接口的 Web 服务器，在模块<a href="https://docs.python.org/2.7/library/wsgiref.html" target="_blank" rel="external">wsgiref</a>中，它是用纯Python编写的WSGI服务器的参考实现，我们一起来简单分析一下它的实现。首先假设我们用下面代码启动一个 Web 服务器：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Instantiate the server</span></div><div class="line">httpd = make_server(</div><div class="line">    <span class="string">'localhost'</span>,    <span class="comment"># The host name</span></div><div class="line">    <span class="number">8051</span>,           <span class="comment"># A port number where to wait for the request</span></div><div class="line">    application     <span class="comment"># The application object name, in this case a function</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment"># Wait for a single request, serve it and quit</span></div><div class="line">httpd.handle_request()</div></pre></td></tr></table></figure>
<p>然后我们以Web服务器接收一个请求、生成 environ，然后调用 application 来处理请求这条主线来分析源码的调用过程，简化如下图所示：</p>
<p><img src="http://xuelangzf-github.qiniudn.com/20160807_forum_design_WSGI_2.png" alt="WSGI Server 调用流程"></p>
<p>这里主要有三个类，WSGIServer，WSGIRequestHandler，ServerHandle。WSGIServer 是Web服务器类，可以提供server_address（IP:Port）和 WSGIRequestHandler 类来进行初始化获得一个server对象。该对象监听响应的端口，收到HTTP请求后通过 finish_request 创建一个RequestHandler 类的实例，在该实例的初始化过程中会生成一个 Handle 类实例，然后调用其 run(application) 函数，在该函数里面再调用应用程序提供的 application对象来生成响应。</p>
<p>这三个类的继承关系如下图所示：</p>
<p><img src="http://xuelangzf-github.qiniudn.com/20160807_forum_design_WSGI_3.png" alt="WSGI 类继承关系图"></p>
<p>其中 TCPServer 使用 socket 来完成 TCP 通信，HTTPServer 则是用来做 HTTP 层面的处理。同样的，StreamRequestHandler 来处理 stream socket，BaseHTTPRequestHandler 则是用来处理 HTTP 层面的内容，这部分和 WSGI 接口关系不大，更多的是 Web 服务器的具体实现，可以忽略。</p>
<h2 id="微服务器实例"><a href="#微服务器实例" class="headerlink" title="微服务器实例"></a>微服务器实例</h2><p>如果上面的 wsgiref 过于复杂的话，下面一起来实现一个微小的 Web 服务器，便于我们理解 Web 服务器端 WSGI 接口的实现。代码摘自 <a href="http://codingpy.com/article/build-a-simple-web-server-part-two/" target="_blank" rel="external">自己动手开发网络服务器（二）</a>，放在 <a href="https://gist.github.com/xuelangZF/217b1b6ab34ec33c3ca155ce681f72ad" target="_blank" rel="external">gist</a> 上，主要结构如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">WSGIServer</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="comment"># 套接字参数</span></div><div class="line">    address_family, socket_type = socket.AF_INET, socket.SOCK_STREAM</div><div class="line">    request_queue_size = <span class="number">1</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, server_address)</span>:</span></div><div class="line">        <span class="comment"># TCP 服务端初始化：创建套接字，绑定地址，监听端口</span></div><div class="line">        <span class="comment"># 获取服务器地址，端口</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_app</span><span class="params">(self, application)</span>:</span></div><div class="line">        <span class="comment"># 获取框架提供的 application</span></div><div class="line">        self.application = application</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">serve_forever</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="comment"># 处理 TCP 连接：获取请求内容，调用处理函数</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_request</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="comment"># 解析 HTTP 请求，获取 environ，处理请求内容，返回HTTP响应结果</span></div><div class="line">        env = self.get_environ()</div><div class="line">        result = self.application(env, self.start_response)</div><div class="line">        self.finish_response(result)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse_request</span><span class="params">(self, text)</span>:</span></div><div class="line">        <span class="comment"># 解析 HTTP 请求</span></div><div class="line">        </div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_environ</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="comment"># 分析 environ 参数，这里只是示例，实际情况有很多参数。</span></div><div class="line">        env[<span class="string">'wsgi.url_scheme'</span>]   = <span class="string">'http'</span></div><div class="line">        ...</div><div class="line">        env[<span class="string">'REQUEST_METHOD'</span>]    =  self.request_method    <span class="comment"># GET</span></div><div class="line">        ...</div><div class="line">        <span class="keyword">return</span> env</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_response</span><span class="params">(self, status, response_headers, exc_info=None)</span>:</span></div><div class="line">        <span class="comment"># 添加响应头，状态码</span></div><div class="line">        self.headers_set = [status, response_headers + server_headers]</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">finish_response</span><span class="params">(self, result)</span>:</span></div><div class="line">        <span class="comment"># 返回 HTTP 响应信息</span></div><div class="line"></div><div class="line">SERVER_ADDRESS = (HOST, PORT) = <span class="string">''</span>, <span class="number">8888</span></div><div class="line"></div><div class="line"><span class="comment"># 创建一个服务器实例</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_server</span><span class="params">(server_address, application)</span>:</span></div><div class="line">    server = WSGIServer(server_address)</div><div class="line">    server.set_app(application)</div><div class="line">    <span class="keyword">return</span> server</div></pre></td></tr></table></figure>
<p>目前支持 WSGI 的成熟Web服务器有很多，<a href="http://gunicorn.org/" target="_blank" rel="external">Gunicorn</a>是相当不错的一个。它脱胎于ruby社区的Unicorn，成功移植到python上，成为一个WSGI HTTP Server。有以下优点：</p>
<ul>
<li>容易配置</li>
<li>可以自动管理多个worker进程</li>
<li>选择不同的后台扩展接口（sync, gevent, tornado等）</li>
</ul>
<h1 id="应用程序端（框架）"><a href="#应用程序端（框架）" class="headerlink" title="应用程序端（框架）"></a>应用程序端（框架）</h1><p>和服务器端相比，应用程序端（也可以认为框架）要做的事情就简单很多，它只需要提供一个可调用对象（一般习惯将其命名为application），这个对象接收服务器端传递的两个参数 environ 和 start_response。这里的可调用对象不仅可以是函数，还可以是类（下面第二个示例）或者拥有 <code>__call__</code> 方法的实例，总之只要<strong>可以接受前面说的两个参数，并且返回值可以被服务器进行迭代即可</strong>。</p>
<p>Application 具体要做的就是根据 environ 里面提供的关于 HTTP 请求的信息，进行一定的业务处理，返回一个可迭代对象，服务器端通过迭代这个对象，来获得 HTTP 响应的正文。如果没有响应正文，那么可以返回None。</p>
<p>同时，application 还会调用服务器提供的 start_response，产生HTTP响应的状态码和响应头，原型如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">start_response</span><span class="params">(self, status, headers,exc_info=None)</span>:</span></div></pre></td></tr></table></figure>
<p>Application 需要提供 status：一个字符串，表示HTTP响应状态字符串，还有 response_headers: 一个列表，包含有如下形式的元组：(header_name, header_value)，用来表示HTTP响应的headers。同时 exc_info 是可选的，用于出错时，server需要返回给浏览器的信息。</p>
<p>到这里为止，我们就可以实现一个简单的 application 了，如下所示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">simple_app</span><span class="params">(environ, start_response)</span>:</span></div><div class="line">    <span class="string">"""Simplest possible application function"""</span></div><div class="line">    HELLO_WORLD = <span class="string">"Hello world!\n"</span></div><div class="line">    status = <span class="string">'200 OK'</span></div><div class="line">    response_headers = [(<span class="string">'Content-type'</span>, <span class="string">'text/plain'</span>)]</div><div class="line">    start_response(status, response_headers)</div><div class="line">    <span class="keyword">return</span> [HELLO_WORLD]</div></pre></td></tr></table></figure>
<p>或者用类实现如下。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppClass</span>:</span></div><div class="line">    <span class="string">"""Produce the same output, but using a class"""</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, environ, start_response)</span>:</span></div><div class="line">        self.environ = environ</div><div class="line">        self.start = start_response</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(self)</span>:</span></div><div class="line">        ...</div><div class="line">        HELLO_WORLD = <span class="string">"Hello world!\n"</span></div><div class="line">        <span class="keyword">yield</span> HELLO_WORLD</div></pre></td></tr></table></figure>
<p>注意这里 <code>AppClass</code> 类本身就是 application，用 environ 和 start_response 调用（实例化）它返回一个实例对象，这个实例对象本身是可迭代的，符合 WSGI 对 application 的要求。</p>
<p>如果想使用 AppClass 类的对象作为 application，那么必须给类添加一个 <code>__call__</code> 方法，接受 environ 和 start_response 为参数，返回可迭代对象，如下所示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppClass</span>:</span></div><div class="line">    <span class="string">"""Produce the same output, but using an object"""</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, environ, start_response)</span>:</span></div><div class="line">        ...</div></pre></td></tr></table></figure>
<p>这部分涉及到python的一些高级特性，比如 yield 和 magic method，可以参考我总结的<a href="https://github.com/xuelangZF/CS_Offer/tree/master/Python" target="_blank" rel="external">python语言要点</a>来理解。 </p>
<h2 id="Flask-中的-WSGI"><a href="#Flask-中的-WSGI" class="headerlink" title="Flask 中的 WSGI"></a>Flask 中的 WSGI</h2><p>flask 是一个轻量级的Python Web框架，符合 WSGI 的规范要求。它的最初版本只有 600 多行，相对便于理解。下面我们来看下它最初版本中关于 WSGI 接口的部分。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">wsgi_app</span><span class="params">(self, environ, start_response)</span>:</span></div><div class="line">    <span class="string">"""The actual WSGI application.</span></div><div class="line"></div><div class="line">    This is not implemented in `__call__` so that middlewares can be applied:</div><div class="line">        app.wsgi_app = MyMiddleware(app.wsgi_app)</div><div class="line">    """</div><div class="line">    <span class="keyword">with</span> self.request_context(environ):</div><div class="line">        rv = self.preprocess_request()</div><div class="line">        <span class="keyword">if</span> rv <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">            rv = self.dispatch_request()</div><div class="line">        response = self.make_response(rv)</div><div class="line">        response = self.process_response(response)</div><div class="line">        <span class="keyword">return</span> response(environ, start_response)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, environ, start_response)</span>:</span></div><div class="line">    <span class="string">"""Shortcut for :attr:`wsgi_app`"""</span></div><div class="line">    <span class="keyword">return</span> self.wsgi_app(environ, start_response)</div></pre></td></tr></table></figure>
<p>这里的 wsgi_app 实现了我们说的 application 功能，rv 是 对请求的封装，response 是框架用来处理业务逻辑的具体函数。这里对 flask 源码不做过多解释，感兴趣的可以去github下载，然后check 到最初版本去查看。</p>
<h1 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h1><p>前面 flask 代码 wsgi_app 函数的注释中提到不直接在 <code>__call__</code> 中实现 application 部分，是为了可以使用<code>中间件</code>。 那么为什么要使用中间件，中间件又是什么呢？</p>
<p>回顾前面的 application/server 端接口，对于一个 HTTP 请求，server 端总是会调用一个 application 来进行处理，并返回 application 处理后的结果。这足够应付一般的场景了，不过并不完善，考虑下面的几种应用场景：</p>
<ul>
<li>对于不同的请求（比如不同的 URL），server 需要调用不同的 application，那么如何选择调用哪个呢；</li>
<li>为了做负载均衡或者是远程处理，需要使用网络上其他主机上运行的 application 来做处理；</li>
<li>需要对 application 返回的内容做一定处理后才能作为 HTTP 响应；</li>
</ul>
<p>上面这些场景有一个共同点就是，有一些必需的操作不管放在服务端还是应用（框架）端都不合适。对应用端来说，这些操作应该由服务器端来做，对服务器端来说，这些操作应该由应用端来做。为了处理这种情况，引入了<code>中间件</code>。</p>
<p>中间件就像是应用端和服务端的桥梁，来沟通两边。对服务器端来说，中间件表现的像是应用端，对应用端来说，它表现的像是服务器端。如下图所示：</p>
<p><img src="http://xuelangzf-github.qiniudn.com/20160807_forum_design_WSGI_4.png" alt="中间件"></p>
<h2 id="中间件的实现"><a href="#中间件的实现" class="headerlink" title="中间件的实现"></a>中间件的实现</h2><p>flask 框架在 Flask 类的初始化代码中就使用了中间件：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">self.wsgi_app = SharedDataMiddleware(self.wsgi_app, &#123; self.static_path: target &#125;)</div></pre></td></tr></table></figure>
<p>这里的作用和 python 中的装饰器一样，就是在执行 self.wsgi_app 前后执行 SharedDataMiddleware 中的一些内容。中间件做的事，很类似python中装饰器做的事情。SharedDataMiddleware 中间件是 <a href="https://github.com/pallets/werkzeug/blob/2e9f5c0d0c1c36b612f6797c00f8c6ac3ba7b1db/werkzeug/wsgi.py" target="_blank" rel="external">werkzeug</a> 库提供的，用来支持站点托管静态内容。此外，还有DispatcherMiddleware 中间件，用来支持根据不同的请求，调用不同的 application，这样就可以解决前面场景 1, 2 中的问题了。</p>
<p>下面来看看 DispatcherMiddleware 的实现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">DispatcherMiddleware</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="string">"""Allows one to mount middlewares or applications in a WSGI application.</span></div><div class="line">    This is useful if you want to combine multiple WSGI applications::</div><div class="line">        app = DispatcherMiddleware(app, &#123;</div><div class="line">            '/app2':        app2,</div><div class="line">            '/app3':        app3</div><div class="line">        &#125;)</div><div class="line">    """</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, app, mounts=None)</span>:</span></div><div class="line">        self.app = app</div><div class="line">        self.mounts = mounts <span class="keyword">or</span> &#123;&#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, environ, start_response)</span>:</span></div><div class="line">        script = environ.get(<span class="string">'PATH_INFO'</span>, <span class="string">''</span>)</div><div class="line">        path_info = <span class="string">''</span></div><div class="line">        <span class="keyword">while</span> <span class="string">'/'</span> <span class="keyword">in</span> script:</div><div class="line">            <span class="keyword">if</span> script <span class="keyword">in</span> self.mounts:</div><div class="line">                app = self.mounts[script]</div><div class="line">                <span class="keyword">break</span></div><div class="line">            script, last_item = script.rsplit(<span class="string">'/'</span>, <span class="number">1</span>)</div><div class="line">            path_info = <span class="string">'/%s%s'</span> % (last_item, path_info)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            app = self.mounts.get(script, self.app)</div><div class="line">        original_script_name = environ.get(<span class="string">'SCRIPT_NAME'</span>, <span class="string">''</span>)</div><div class="line">        environ[<span class="string">'SCRIPT_NAME'</span>] = original_script_name + script</div><div class="line">        environ[<span class="string">'PATH_INFO'</span>] = path_info</div><div class="line">        <span class="keyword">return</span> app(environ, start_response)</div></pre></td></tr></table></figure>
<p>初始化中间件时需要提供一个 mounts 字典，用来指定不同 URL 路径到 application 的映射关系。这样对于一个请求，中间件检查其路径，然后选择合适的 application 进行处理。</p>
<p>关于 WSGI 的原理部分基本结束，下一篇我会介绍下对 flask 框架的理解。</p>
<h1 id="更多阅读"><a href="#更多阅读" class="headerlink" title="更多阅读"></a>更多阅读</h1><p><a href="https://wsgi.readthedocs.io/en/latest/" target="_blank" rel="external">WSGI Content</a><br><a href="http://wsgi.tutorial.codepoint.net/intro" target="_blank" rel="external">WSGI Tutorial by Clodoaldo Neto</a><br><a href="http://linuxgazette.net/115/orr.html" target="_blank" rel="external">WSGI Explorations in Python</a><br><a href="http://codingpy.com/article/build-a-simple-web-server-part-two/" target="_blank" rel="external">自己动手开发网络服务器（二）</a><br><a href="https://segmentfault.com/a/1190000003069785" target="_blank" rel="external">WSGI 是什么?</a><br><a href="https://segmentfault.com/a/1190000005640475" target="_blank" rel="external">自己写一个 wsgi 服务器运行 Django 、Tornado 等框架应用</a><br><a href="https://www.python.org/dev/peps/pep-3333/" target="_blank" rel="external">PEP 3333 – Python Web Server Gateway Interface v1.0.1</a><br><a href="http://stackoverflow.com/questions/111234/what-is-a-callable-in-python" target="_blank" rel="external">What is a “callable” in Python?</a>  </p>
</div><div class="article-footer-copyright"><p>本文由<b>selfboot</b> 发表于<a href="http://selfboot.cn">个人博客</a>，采用<a href="http://creativecommons.org/licenses/by-sa/3.0/cn" target="_blank">署名-非商业性使用-相同方式共享 3.0 中国大陆许可协议。</a></p><p>非商业转载请注明作者及出处。商业转载请联系<a href="mailto:xuezaigds@gmail.com">作者本人</a></p><p>本文标题为：从零开始搭建论坛（二）：Web服务器网关接口</p><p>本文链接为：http://selfboot.cn/2016/08/07/forum_design_wsgi/</p></div><div class="post-donate"><div id="donate_board" class="donate_bar center"><a id="btn_donate" href="javascript:;" title="打赏" class="btn_donate"></a><div class="donate_txt"> &uarr;<br>内容不错，打赏你啦<br></div></div><div id="donate_guide" class="donate_bar center hidden"><img src="http://xuelangzf-github.qiniudn.com/weixin.jpg" title="微信打赏"><img src="http://xuelangzf-github.qiniudn.com/zhifubao.jpg" title="支付宝打赏"></div><script type="text/javascript">document.getElementById('btn_donate').onclick = function(){
    $('#donate_board').addClass('hidden');
    $('#donate_guide').removeClass('hidden');
}</script></div><div class="addthis_sharing_toolbox"></div><div class="tags"><a href="/tags/Python/">Python</a><a href="/tags/Flask/">Flask</a></div><div class="post-nav"><a href="/2016/08/22/threadlocal_overview/" class="pre">深入理解Python中的ThreadLocal变量（上）</a><a href="/2016/07/28/forum_design_framework/" class="next">从零开始搭建论坛（一）：Web服务器与Web框架</a></div><div id="disqus_thread"><script>var disqus_shortname = 'xuelangZF';
var disqus_identifier = '2016/08/07/forum_design_wsgi/';
var disqus_title = '从零开始搭建论坛（二）：Web服务器网关接口';
var disqus_url = 'http://selfboot.cn/2016/08/07/forum_design_wsgi/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//xuelangZF.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://selfboot.cn"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/工具介绍/">工具介绍</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据结构与算法/">数据结构与算法</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/源码剖析/">源码剖析</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/社会百态/">社会百态</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/程序设计/">程序设计</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/计算机基础/">计算机基础</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/计算机网络/">计算机网络</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/项目实践/">项目实践</a><span class="category-list-count">3</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Django/" style="font-size: 15px;">Django</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/总结/" style="font-size: 15px;">总结</a> <a href="/tags/方法/" style="font-size: 15px;">方法</a> <a href="/tags/Google/" style="font-size: 15px;">Google</a> <a href="/tags/思考/" style="font-size: 15px;">思考</a> <a href="/tags/JavaScript/" style="font-size: 15px;">JavaScript</a> <a href="/tags/教程/" style="font-size: 15px;">教程</a> <a href="/tags/DNS/" style="font-size: 15px;">DNS</a> <a href="/tags/见闻/" style="font-size: 15px;">见闻</a> <a href="/tags/GUI/" style="font-size: 15px;">GUI</a> <a href="/tags/Protocol/" style="font-size: 15px;">Protocol</a> <a href="/tags/Flask/" style="font-size: 15px;">Flask</a> <a href="/tags/C/" style="font-size: 15px;">C++</a> <a href="/tags/Thread/" style="font-size: 15px;">Thread</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/11/12/postman_read_doc/">Postman 高级用法指南</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/28/py_encode_decode/">Python2.x 字符编码终极指南</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/03/threadlocal_enhance/">深入理解Python中的ThreadLocal变量（下）</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/30/forum_design_flask/">从零开始搭建论坛（三）：Flask框架简单介绍</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/18/c++_undefined_behaviours/">C++ 中的未定义行为</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/01/lost_partition/">被忽视的 partition 算法</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/26/threadlocal_implement/">深入理解Python中的ThreadLocal变量（中）</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/22/threadlocal_overview/">深入理解Python中的ThreadLocal变量（上）</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/07/forum_design_wsgi/">从零开始搭建论坛（二）：Web服务器网关接口</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/28/forum_design_framework/">从零开始搭建论坛（一）：Web服务器与Web框架</a></li></ul></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-list-ul"> 文章目录</i></div><ul class="dsq-widget-list"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#服务器端"><span class="toc-number">1.</span> <span class="toc-text">服务器端</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#wsgiref-分析"><span class="toc-number">1.1.</span> <span class="toc-text">wsgiref 分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#微服务器实例"><span class="toc-number">1.2.</span> <span class="toc-text">微服务器实例</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#应用程序端（框架）"><span class="toc-number">2.</span> <span class="toc-text">应用程序端（框架）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Flask-中的-WSGI"><span class="toc-number">2.1.</span> <span class="toc-text">Flask 中的 WSGI</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#中间件"><span class="toc-number">3.</span> <span class="toc-text">中间件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#中间件的实现"><span class="toc-number">3.1.</span> <span class="toc-text">中间件的实现</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#更多阅读"><span class="toc-number">4.</span> <span class="toc-text">更多阅读</span></a></li></ol></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <script async="" src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><a href="/." rel="nofollow">Just For Fun.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/tufu9441"> tufu9441.</a><p> Hosted by<a rel="nofollow" target="_blank" href="https://pages.coding.me" style="font-weight: bold"> Coding Pages</a></p><p><span id="busuanzi_container_site_pv"></span>本站总访问量<span id="busuanzi_value_site_pv"></span>次，<span id="busuanzi_container_site_uv"></span>本站访客数<span id="busuanzi_value_site_uv"></span>人次</p></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=1.0.0"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-41784041-1','auto');ga('send','pageview');
</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?fd3ab4b3c488cbb43afa1c2669f06648";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/toc.js?v=1.0.0"></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script><script type="text/javascript" src="http://s7.addthis.com/js/300/addthis_widget.js#pubid=ra-57adc438b914651b"></script></div></body></html>